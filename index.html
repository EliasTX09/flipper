<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flipper Minimal WebFlasher</title>
  <style>
    body { font-family: monospace; background: #111; color: #eee; padding: 20px; }
    button, input { margin: 5px; padding: 8px; }
    #log { background: #000; color: #0f0; padding: 10px; height: 200px; overflow-y: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Flipper Minimal WebFlasher</h1>
  <input type="file" id="fw" accept=".zip,.tgz,.tar.gz">
  <button id="connect">üîå Verbinden</button>
  <div id="log">Bereit.</div>

  <!-- JSZip und Pako f√ºr Archive -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

  <script>
    const logEl = document.getElementById('log');
    const fwInput = document.getElementById('fw');
    let selectedEntries = [];

    function log(msg) {
      logEl.textContent += "\n" + msg;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // --- Serial handling ---
    let port;
    async function connectFlipper() {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        log("‚úÖ Verbunden mit Flipper");
      } catch (err) {
        log("‚ùå Fehler beim Verbinden: " + err);
      }
    }

    // --- Datei-Handling ---
    function parseTar(u8) {
      const files=[]; const block=512; let off=0;
      const dec=new TextDecoder(); const readStr=a=>dec.decode(a).replace(/\0+$/,'').trim();
      while(off+block<=u8.length){
        const h=u8.subarray(off,off+block); const name=readStr(h.subarray(0,100));
        if(!name){ if(h.every(b=>b===0)) break; off+=block; continue; }
        const size=parseInt(readStr(h.subarray(124,136)),8)||0; off+=block;
        const data=u8.subarray(off,off+size);
        files.push({path:name,data:new Uint8Array(data)});
        off+=Math.ceil(size/block)*block;
      }
      return files;
    }

    fwInput.addEventListener('change', async () => {
      try {
        const file = fwInput.files[0];
        const buf = new Uint8Array(await file.arrayBuffer());
        let entries=[];
        const name = file.name.toLowerCase();
        if (name.endsWith('.zip')) {
          const zip = await JSZip.loadAsync(buf);
          for (const k of Object.keys(zip.files)) {
            const e = zip.files[k]; if (e.dir) continue;
            entries.push({path:k, data:new Uint8Array(await e.async('uint8array'))});
          }
        } else {
          const tarData = name.endsWith('.tgz')||name.endsWith('.tar.gz') ? pako.ungzip(buf) : buf;
          entries = parseTar(tarData);
        }
        selectedEntries = entries;
        log(`${entries.length} Datei(en) geladen`);
      } catch (err) {
        log("‚ùå Fehler beim Laden der Firmware: " + err);
      }
    });

    document.getElementById('connect').onclick = connectFlipper;
  </script>
</body>
</html>
