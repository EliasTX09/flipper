<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Flipper WebUpdater (Beta)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; padding:20px; }
    button { margin:5px; padding:10px 20px; border-radius:6px; border:none; cursor:pointer; }
    button:hover { opacity:0.8; }
    #log { background:#222; padding:10px; border-radius:6px; height:300px; overflow-y:auto; white-space:pre-wrap; }
    #progress { background:#333; border-radius:6px; height:20px; margin:10px 0; }
    #bar { background:lime; height:100%; width:0%; border-radius:6px; }
  </style>
</head>
<body>
  <h1>⚡ Flipper Zero WebUpdater</h1>

  <input type="file" id="fwFile" />
  <br><br>

  <button id="connectBtn">🔌 Connect</button>
  <button id="disconnectBtn">❌ Disconnect</button>
  <button id="rebootBtn">🔄 Reboot</button>
  <button id="updateBtn">⬆️ Update</button>

  <div id="progress"><div id="bar"></div></div>
  <h3>Logs</h3>
  <div id="log"></div>

  <script>
    const logEl = document.getElementById("log");
    const barEl = document.getElementById("bar");
    const fwFileInput = document.getElementById("fwFile");

    function log(msg) {
      console.log(msg);
      logEl.textContent += "\n" + msg;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setProgress(p) {
      barEl.style.width = Math.max(0, Math.min(100, p)) + "%";
    }

    // === WebSerial Transport ===
    let port = null;
    let writer = null;
    let reader = null;

    async function connect() {
      log("➡️ Starte Connect...");
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });
      writer = port.writable.getWriter();
      reader = port.readable.getReader();
      log("✅ Serial-Port geöffnet");
      return true;
    }

    async function disconnect() {
      log("➡️ Starte Disconnect...");
      if (reader) { await reader.cancel(); reader.releaseLock(); reader=null; }
      if (writer) { writer.releaseLock(); writer=null; }
      if (port) { await port.close(); port=null; }
      log("❌ Serial-Port geschlossen");
    }

    async function write(data) {
      if (!writer) throw new Error("Kein Writer aktiv");
      log("➡️ Sende Daten (" + data.length + " Bytes)");
      await writer.write(data);
    }

    async function read() {
      if (!reader) throw new Error("Kein Reader aktiv");
      const { value, done } = await reader.read();
      log("⬅️ Gelesene Daten: " + (value ? value.length : 0) + " Bytes");
      return { value, done };
    }

    async function closeReader() {
      if (reader) {
        await reader.cancel();
        reader.releaseLock();
        reader = null;
        log("ℹ️ Reader geschlossen");
      }
    }

    // === Stubs für RPC-Kommandos ===
    const commands = {
      system: {
        reboot: async (mode="os") => {
          log("🚧 Stub: Reboot-Befehl gesendet (Mode=" + mode + ")");
          // hier müsste RPC-Kommando encoded gesendet werden
        }
      },
      storage: {
        write: async (path, buf) => {
          log("🚧 Stub: Firmware würde nach " + path + " geschrieben (" + buf.length + " Bytes)");
        }
      }
    };

    // === window.flipper API ===
    window.flipper = { connect, disconnect, write, read, closeReader, commands };

    log("📢 Seite geladen");
    log("📢 window.flipper Keys: " + Object.keys(window.flipper));

    // === Button Handler ===
    document.getElementById("connectBtn").addEventListener("click", async () => {
      try {
        await window.flipper.connect();
        log("✅ Verbunden mit Flipper");
      } catch (err) {
        log("❌ Fehler beim Verbinden: " + err);
      }
    });

    document.getElementById("disconnectBtn").addEventListener("click", async () => {
      try {
        await window.flipper.disconnect();
        log("❌ Getrennt");
      } catch (err) {
        log("❌ Fehler beim Trennen: " + err);
      }
    });

    document.getElementById("rebootBtn").addEventListener("click", async () => {
      try {
        await window.flipper.commands.system.reboot("os");
        log("🔄 Reboot gesendet");
      } catch (err) {
        log("❌ Fehler beim Reboot: " + err);
      }
    });

    document.getElementById("updateBtn").addEventListener("click", async () => {
      if (!fwFileInput.files.length) {
        log("⚠️ Bitte zuerst eine Firmware-Datei auswählen!");
        return;
      }
      const file = fwFileInput.files[0];
      log("📦 Lade Firmware: " + file.name);
      try {
        const buf = new Uint8Array(await file.arrayBuffer());
        log("➡️ Sende Firmware an Flipper...");
        setProgress(0);
        await window.flipper.commands.storage.write("/ext/update/" + file.name, buf);
        setProgress(100);
        log("✅ Upload abgeschlossen (Stub). Update muss am Flipper gestartet werden.");
      } catch (err) {
        log("❌ Fehler beim Update: " + err);
      }
    });
  </script>
</body>
</html>
