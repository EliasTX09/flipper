<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Flipper WebUpdater</title>
  <style>
    body { background:#111; color:#eee; font-family:monospace; padding:20px; }
    #log { background:#222; padding:10px; height:320px; overflow-y:auto; white-space:pre-wrap; margin-top:10px; }
    button { margin:4px; padding:8px 16px; border:none; border-radius:4px; cursor:pointer; }
    button:hover { opacity:0.8; }
    #progress { width: 100%; background:#333; border-radius:4px; margin-top:10px; }
    #bar { width:0; height:12px; background:#0f0; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Flipper WebUpdater</h1>

  <input type="file" id="fwFile" /><br><br>

  <button id="btnConnect">Connect</button>
  <button id="btnDisconnect">Disconnect</button>
  <button id="btnReboot">Reboot</button>
  <button id="btnUpdate">Upload Firmware</button>

  <div id="progress"><div id="bar"></div></div>
  <div id="log"></div>

  <!-- protobuf runtime -->
  <script src="https://unpkg.com/protobufjs/dist/protobuf.min.js"></script>

  <!-- flipper-rpc.js from GitHub raw, adapted to map window.flipper -->
  <script>
    (function(){
      // Dynamically load your flipper-rpc.js
      const s = document.createElement('script');
      s.src = 'https://raw.githubusercontent.com/EliasTX09/flipper/refs/heads/main/flipper-rpc.js';
      s.onload = () => {
        if (typeof connect !== "undefined") {
          window.flipper = {
            connect, disconnect, write, read, closeReader,
            commands: typeof commands !== "undefined" ? commands : null,
            emitter: typeof emitter !== "undefined" ? emitter : null
          };
          log('‚úÖ window.flipper initialized: ' + JSON.stringify(Object.keys(window.flipper)));
        } else {
          log('‚ùå connect() not found in RPC bundle. Is it browser-ready?');
        }
      };
      s.onerror = () => log('‚ùå Failed to load flipper-rpc.js');
      document.head.appendChild(s);
    })();
  </script>

  <script>
    const logEl = document.getElementById('log');
    const barEl = document.getElementById('bar');
    const fwInput = document.getElementById('fwFile');

    function log(msg) {
      console.log(msg);
      logEl.textContent += "\n" + msg;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setProgress(p) {
      barEl.style.width = Math.min(100, Math.max(0, p)) + '%';
    }

    document.getElementById('btnConnect').onclick = async () => {
      if (!window.flipper) return log('API missing');
      log('üîå Connecting...');
      try {
        await window.flipper.connect();
        log('‚úÖ Connected');
      } catch (e) {
        log('‚ùå Connect error: ' + e);
      }
    };

    document.getElementById('btnDisconnect').onclick = async () => {
      if (!window.flipper) return log('API missing');
      log('‚úÇ Disconnecting...');
      try {
        await window.flipper.disconnect();
        log('‚úÖ Disconnected');
      } catch (e) {
        log('‚ùå Disconnect error: ' + e);
      }
    };

    document.getElementById('btnReboot').onclick = async () => {
      if (!window.flipper?.commands) return log('commands missing');
      log('üîÑ Sending reboot...');
      try {
        await window.flipper.commands.system.reboot('os');
        log('‚úÖ Reboot sent');
      } catch (e) {
        log('‚ùå Reboot error: ' + e);
      }
    };

    document.getElementById('btnUpdate').onclick = async () => {
      const file = fwInput.files[0];
      if (!file) return log('No firmware file selected');
      if (!window.flipper?.commands) return log('commands missing');
      log('Uploading firmware: ' + file.name);
      try {
        const data = new Uint8Array(await file.arrayBuffer());
        await window.flipper.commands.storage.write('/ext/update/' + file.name, data);
        setProgress(100);
        log('‚úÖ Upload complete');
      } catch (e) {
        log('‚ùå Upload error: ' + e);
      }
    };
  </script>
</body>
</html>
