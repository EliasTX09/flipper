<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Flipper Serial Tools (Basis)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0b0f; color:#e8e8ee; margin:0; }
    header { padding:16px 20px; border-bottom:1px solid #1f2030; position:sticky; top:0; background:#0b0b0f; z-index:10; }
    h1 { margin:0; font-size:18px; font-weight:600; letter-spacing:.3px; }
    main { padding:20px; display:grid; gap:16px; max-width:1100px; margin:auto; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button, input, select { background:#151628; color:#e8e8ee; border:1px solid #2a2b40; border-radius:10px; padding:10px 14px; font-size:14px; }
    button { cursor:pointer; transition:transform .06s ease, opacity .15s ease; }
    button:hover { opacity:.9; }
    button:active { transform:scale(.98); }
    .ok { color:#8fff9a; } .warn { color:#ffd36e; } .bad { color:#ff7a7a; }
    .card { background:#0f1020; border:1px solid #1f2030; border-radius:16px; padding:14px; }
    #log { background:#0a0b18; border:1px solid #1c1d2b; border-radius:12px; padding:10px; height:340px; overflow:auto; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12.5px; }
    .pill { border-radius:999px; padding:6px 10px; border:1px solid #2a2b40; background:#121327; font-size:12px; }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap:8px 14px; font-size:13px; }
    .muted { opacity:.75 }
    .hr { height:1px; background:#1d1e2c; margin:8px 0 6px; border:none; }
    .cmdrow { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .grow { flex:1 1 240px; }
  </style>
</head>
<body>
  <header>
    <h1>‚ö° Flipper Serial Tools ‚Äî Basis & Diagnose</h1>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <button id="btnConnect">üîå Connect</button>
        <button id="btnDisconnect" disabled>‚ùå Disconnect</button>
        <span id="status" class="pill muted">Status: nicht verbunden</span>
      </div>
      <div class="kv" style="margin-top:10px">
        <div class="muted">Browser:</div><div id="capBrowser"></div>
        <div class="muted">Web Serial:</div><div id="capSerial"></div>
        <div class="muted">Port Info:</div><div id="capPort">‚Äì</div>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <strong>Quick-Actions</strong>
      </div>
      <div class="row" style="margin-top:6px">
        <button id="btnPing" disabled>üìü send ‚Äúhelp‚Äù</button>
        <button id="btnReboot" disabled>üîÑ reboot</button>
        <button id="btnStartRpc" disabled>üß© start_rpc_session</button>
      </div>
      <div class="hr"></div>
      <div class="cmdrow">
        <input class="grow" id="cmdInput" placeholder='Custom Befehl, z. B.: storage list /ext' />
        <button id="btnSend" disabled>‚û°Ô∏è Senden</button>
      </div>
      <p class="muted" style="margin:8px 2px 0">
        Hinweis: Diese Datei nutzt **nur** die serielle CLI (Text). F√ºr echtes RPC (Binary/Protobuf) braucht es sp√§ter zus√§tzliche Logik.
      </p>
    </section>

    <section class="card">
      <div class="row"><strong>Logs</strong></div>
      <div id="log"></div>
      <div class="row">
        <button id="btnClear">üßπ Log leeren</button>
        <span class="muted">EOL: <code>\r</code> (CR)</span>
      </div>
    </section>
  </main>

  <script>
    // ---------- Mini UI helpers ----------
    const $ = sel => document.querySelector(sel);
    const logEl = $("#log");
    const statusEl = $("#status");
    const portInfoEl = $("#capPort");
    const capBrowserEl = $("#capBrowser");
    const capSerialEl = $("#capSerial");

    const btnConnect = $("#btnConnect");
    const btnDisconnect = $("#btnDisconnect");
    const btnPing = $("#btnPing");
    const btnReboot = $("#btnReboot");
    const btnStartRpc = $("#btnStartRpc");
    const btnSend = $("#btnSend");
    const cmdInput = $("#cmdInput");
    const btnClear = $("#btnClear");

    function log(line, cls) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${line}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setStatus(txt, kind="") {
      statusEl.textContent = `Status: ${txt}`;
      statusEl.className = `pill ${kind||"muted"}`;
    }
    function setButtons(connected) {
      btnConnect.disabled   = connected;
      btnDisconnect.disabled= !connected;
      btnPing.disabled      = !connected;
      btnReboot.disabled    = !connected;
      btnStartRpc.disabled  = !connected;
      btnSend.disabled      = !connected || !cmdInput.value.trim();
    }

    // ---------- Feature check ----------
    capBrowserEl.textContent = `${navigator.userAgent}`;
    const webSerialOK = "serial" in navigator;
    capSerialEl.innerHTML = webSerialOK
      ? '<span class="ok">‚úì verf√ºgbar</span>'
      : '<span class="bad">‚úó nicht verf√ºgbar (Chrome/Edge nutzen)</span>';

    // ---------- Serial plumbing ----------
    let port = null;
    let reader = null;
    let writer = null;
    let textDec = null;
    let textEnc = null;

    async function connectSerial() {
      if (!("serial" in navigator)) {
        log("‚ùå Web Serial nicht verf√ºgbar (Chrome/Edge Desktop verwenden!)", "bad");
        return;
      }
      try {
        // Optional: Flipper USB IDs filtern (wenn bekannt); ohne Filter zeigt der Picker alle Ports
        // const filters = [{ usbVendorId: 0x0483 }]; // Beispiel/STM ‚Äî ggf. leer lassen
        // port = await navigator.serial.requestPort({ filters });
        port = await navigator.serial.requestPort(); // User-Picker
        await port.open({ baudRate: 115200 });

        textDec = new TextDecoderStream();
        const readableClosed = port.readable.pipeTo(textDec.writable);
        reader = textDec.readable.getReader();

        textEnc = new TextEncoderStream();
        const writableClosed = textEnc.readable.pipeTo(port.writable);
        writer = textEnc.writable.getWriter();

        setStatus("verbunden", "ok");
        setButtons(true);

        try {
          const info = port.getInfo ? port.getInfo() : {};
          portInfoEl.textContent = JSON.stringify(info);
        } catch {
          portInfoEl.textContent = "(keine Port-Info)";
        }

        log("‚úÖ Verbunden. Warte auf Ausgabe‚Ä¶");
        readLoop().catch(err => log("‚ùå readLoop Fehler: " + err, "bad"));
      } catch (err) {
        log("‚ùå Connect-Fehler: " + err, "bad");
        setStatus("Fehler beim Verbinden", "bad");
        setButtons(false);
      }
    }

    async function readLoop() {
      // Kontinuierlich Text aus dem Ger√§t einlesen
      while (port && reader) {
        const { value, done } = await reader.read();
        if (done) break;
        if (value) log(value);
      }
    }

    async function writeLine(line) {
      if (!writer) throw new Error("Writer nicht bereit");
      // Flipper CLI erwartet CR oder CRLF; wir schicken CR
      await writer.write(line + "\r");
    }

    async function disconnectSerial() {
      try {
        setStatus("trenne‚Ä¶");
        if (reader) {
          try { await reader.cancel(); } catch {}
          reader.releaseLock();
          reader = null;
        }
        if (writer) {
          try { await writer.close(); } catch {}
          writer.releaseLock();
          writer = null;
        }
        if (port) {
          try { await port.close(); } catch {}
          port = null;
        }
        setStatus("getrennt");
        setButtons(false);
        portInfoEl.textContent = "‚Äì";
        log("üîå Getrennt.");
      } catch (err) {
        log("‚ùå Disconnect-Fehler: " + err, "bad");
      }
    }

    // ---------- Button handlers ----------
    btnConnect.addEventListener("click", async () => {
      log("üñ± Connect geklickt");
      await connectSerial();
      // Nach Connect oft hilfreich: eine leere Zeile senden, um Prompt zu triggern.
      try { await writeLine(""); } catch {}
    });

    btnDisconnect.addEventListener("click", () => {
      log("üñ± Disconnect geklickt");
      disconnectSerial();
    });

    btnPing.addEventListener("click", async () => {
      log("üñ± send ‚Äòhelp‚Äô");
      try {
        await writeLine("help");
      } catch (err) {
        log("‚ùå Sende-Fehler: " + err, "bad");
      }
    });

    btnReboot.addEventListener("click", async () => {
      log("üñ± reboot senden");
      try {
        await writeLine("reboot");
        // Je nach CLI kann es "reboot", "system reboot", o.√§. sein.
        // Wenn dein Flipper ‚Äûunknown command‚Äú ausgibt, probier:
        // await writeLine("system reboot");
      } catch (err) {
        log("‚ùå Sende-Fehler: " + err, "bad");
      }
    });

    btnStartRpc.addEventListener("click", async () => {
      log("üñ± start_rpc_session senden (nur Text, keine Protobufs!)");
      try {
        await writeLine("start_rpc_session");
        log("‚ÑπÔ∏è Falls jetzt Bin√§rdaten kommen: das ist erwartbar ‚Äì hier fehlt noch der RPC/Protobuf-Teil.");
      } catch (err) {
        log("‚ùå Sende-Fehler: " + err, "bad");
      }
    });

    cmdInput.addEventListener("input", () => {
      btnSend.disabled = !port || !cmdInput.value.trim();
    });

    btnSend.addEventListener("click", async () => {
      const cmd = cmdInput.value.trim();
      if (!cmd) return;
      log("‚û°Ô∏è " + cmd);
      try {
        await writeLine(cmd);
      } catch (err) {
        log("‚ùå Sende-Fehler: " + err, "bad");
      }
    });

    btnClear.addEventListener("click", () => {
      logEl.textContent = "";
    });

    // ---------- Life-cycle ----------
    (async () => {
      log("üì¢ Seite geladen");
      if (!("serial" in navigator)) {
        log("‚ùå Web Serial fehlt. Bitte Chrome oder Edge (Desktop) verwenden.", "bad");
      } else {
        log("‚úÖ Web Serial verf√ºgbar. Klicke auf Connect und w√§hle den Flipper-Port.");
      }
      setButtons(false);
    })();
  </script>
</body>
</html>
